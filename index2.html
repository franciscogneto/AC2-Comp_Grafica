<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

    <title>Babylon.js AC2 180141 180854 - Apple Hunting </title>

    <!-- Babylon.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.6.2/dat.gui.min.js"></script>
    <script src="https://preview.babylonjs.com/ammo.js"></script>
    <script src="https://preview.babylonjs.com/cannon.js"></script>
    <script src="https://preview.babylonjs.com/Oimo.js"></script>
    <script src="https://preview.babylonjs.com/earcut.min.js"></script>
    <script src="https://preview.babylonjs.com/babylon.js"></script>
    <script src="https://preview.babylonjs.com/materialsLibrary/babylonjs.materials.min.js"></script>
    <script src="https://preview.babylonjs.com/proceduralTexturesLibrary/babylonjs.proceduralTextures.min.js"></script>
    <script src="https://preview.babylonjs.com/postProcessesLibrary/babylonjs.postProcess.min.js"></script>
    <script src="https://preview.babylonjs.com/loaders/babylonjs.loaders.js"></script>
    <script src="https://preview.babylonjs.com/serializers/babylonjs.serializers.min.js"></script>
    <script src="https://preview.babylonjs.com/gui/babylon.gui.min.js"></script>
    <script src="https://preview.babylonjs.com/inspector/babylon.inspector.bundle.js"></script>

    <style>
        html,
        body {
            overflow: hidden;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #renderCanvas {
            width: 100%;
            height: 100%;
            touch-action: none;
        }
    </style>
</head>

<body>
    <canvas id="renderCanvas"></canvas>
    <script>
        var canvas = document.getElementById("renderCanvas");

        var engine = null;
        var scene = null;
        var sceneToRender = null;
        var createDefaultEngine = function () { return new BABYLON.Engine(canvas, true, { preserveDrawingBuffer: true, stencil: true, disableWebGL2Support: false }); };
        var camera = null;
        var advancedTexture = null;
        var play = false;
        var soundCollectingApple = null;
        var sambaAnim = null;
        var hero = null;
        var totalApples = 10;
        var collectedApples = 0;
        var textScore = null;

        var createScene = function () {

            // Low Poly Character with Blender Tutorial of Grant Abbitt: https://www.youtube.com/user/mediagabbitt
            // Character animations by Mixamo: https://www.mixamo.com/

            engine.enableOfflineSupport = false;

            // Scene
            scene = new BABYLON.Scene(engine);

            // Environment
            create_environment();

            // GUI
            build_GUI();

            // Events
            manager_events();

            // Sounds
            load_sounds();

            // Hero
            load_hero();

            // Collectable Apples
            create_apples();

            // Start Game
            start_game();

            BABYLON.SceneLoader.ImportMesh("", "https://models.babylonjs.com/", "ExplodingBarrel.glb", scene, function (newMeshes, particleSystems, skeletons, animationGroups) {
                var barrel = newMeshes[0];
                barrel.name = name;

                //Scale the barrel model      
                barrel.scaling.scaleInPlace(0.01);

                scene.addMesh(barrel);
            });

            return scene;
        }

        function create_environment() {

            // Camera 
            camera = new BABYLON.ArcRotateCamera("camera", Math.PI / 2, Math.PI / 4, 10, new BABYLON.Vector3(0, -5, 0), scene);
            scene.activeCamera = camera;
            scene.activeCamera.attachControl(canvas, true);
            camera.lowerRadiusLimit = 2;
            camera.upperRadiusLimit = 10;
            camera.wheelDeltaPercentage = 0.01;

            // Lights
            var light = new BABYLON.HemisphericLight("light1", new BABYLON.Vector3(0, 1, 0), scene);
            light.intensity = 0.6;
            light.specular = BABYLON.Color3.Black();

            var light2 = new BABYLON.DirectionalLight("dir01", new BABYLON.Vector3(0, -0.5, -1.0), scene);
            light2.position = new BABYLON.Vector3(0, 5, 5);

            // Skybox
            var skybox = BABYLON.MeshBuilder.CreateBox("skyBox", { size: 1000.0 }, scene);
            var skyboxMaterial = new BABYLON.StandardMaterial("skyBox", scene);
            skyboxMaterial.backFaceCulling = false;
            skyboxMaterial.reflectionTexture = new BABYLON.CubeTexture("http://www.babylonjs-playground.com/textures/skybox4", scene);
            skyboxMaterial.reflectionTexture.coordinatesMode = BABYLON.Texture.SKYBOX_MODE;
            skyboxMaterial.diffuseColor = BABYLON.Color3.Black();
            skyboxMaterial.specularColor = BABYLON.Color3.Black();
            skybox.material = skyboxMaterial;

            // HighMap
            const largeGroundMaterial = new BABYLON.StandardMaterial("largeGroundMat");
            largeGroundMaterial.diffuseTexture = new BABYLON.Texture("https://assets.babylonjs.com/environments/valleygrass.png");
            const largeGround = BABYLON.MeshBuilder.CreateGroundFromHeightMap("largeGround", "https://assets.babylonjs.com/environments/villageheightmap.png", { width: 150, height: 150, subdivisions: 20, minHeight: 0, maxHeight: 10 });
            largeGround.scaling = new BABYLON.Vector3(5, 5, 5);
            largeGround.material = largeGroundMaterial;

            // Tube to delimit the area
            const myPath = [
                new BABYLON.Vector3(0, 0, 0),
                new BABYLON.Vector3(0, 6, 0)
            ];
            const tube = BABYLON.MeshBuilder.CreateTube("tube", { path: myPath, radius: 50, sideOrientation: BABYLON.Mesh.DOUBLESIDE }, scene);
            tube.isVisible = true;
        }

        function build_GUI() {

            advancedTexture;

            if (advancedTexture) {
                advancedTexture.dispose();
            }

            advancedTexture = BABYLON.GUI.AdvancedDynamicTexture.CreateFullscreenUI("UI");

            var topPanel = new BABYLON.GUI.StackPanel();
            topPanel.width = "350px";
            topPanel.isVertical = true;
            topPanel.paddingRight = "0px";
            topPanel.paddingTop = "25px";
            topPanel.horizontalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_CENTER;
            topPanel.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_TOP;
            topPanel.fontSize = 28;
            advancedTexture.addControl(topPanel);

            var autoresPanel = new BABYLON.GUI.StackPanel();
            autoresPanel.width = "350px"
            autoresPanel.height = "100px";
            autoresPanel.isVertical = true;
            autoresPanel.paddingBottom = "20px";
            autoresPanel.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_RIGHT;
            autoresPanel.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_BOTTOM;
            autoresPanel.fontSize = 16;
            advancedTexture.addControl(autoresPanel);

            var comandosPanel = new BABYLON.GUI.StackPanel();
            comandosPanel.width = "155px";
            comandosPanel.isVertical = true;
            comandosPanel.paddingRight = "0px";
            comandosPanel.paddingBottom = "125px";
            comandosPanel.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_RIGHT;
            comandosPanel.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_CENTER;
            comandosPanel.fontSize = 18;
            advancedTexture.addControl(comandosPanel);

            var addHeader = function (text, panel, alinhamento) {
                var header = new BABYLON.GUI.TextBlock();
                header.text = text;
                header.height = "30px";
                header.color = "white";
                header.textHorizontalAlignment = alinhamento;

                panel.addControl(header);
            }

            var alinhamentoEsquerda = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT;
            var alinhamentoCentro = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_CENTER;

            addHeader("Maças Coletadas", topPanel, alinhamentoCentro);

            textScore = new BABYLON.GUI.TextBlock();
            textScore.text = "" + collectedApples;
            textScore.height = "30px";
            textScore.color = "white";
            textScore.textHorizontalAlignment = alinhamentoCentro;
            topPanel.addControl(textScore);

            addHeader("COMANDOS", comandosPanel, alinhamentoEsquerda);
            addHeader("- Mover: W|A|S|D", comandosPanel, alinhamentoEsquerda);
            addHeader("- Sambar: [B]", comandosPanel, alinhamentoEsquerda);
            addHeader("- Câmera: Mouse", comandosPanel, alinhamentoEsquerda);

            addHeader("AUTORES", autoresPanel, alinhamentoCentro);
            addHeader("Francisco Godinho Neto - 180141", autoresPanel, alinhamentoCentro);
            addHeader("Vinícius Cavalcante Silva Souza - 180854", autoresPanel, alinhamentoCentro);
        }

        function manager_events() {

            // Keyboard events
            inputMap = {};
            scene.actionManager = new BABYLON.ActionManager(scene);
            scene.actionManager.registerAction(new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnKeyDownTrigger, function (evt) {
                inputMap[evt.sourceEvent.key] = evt.sourceEvent.type == "keydown";
            }));
            scene.actionManager.registerAction(new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnKeyUpTrigger, function (evt) {
                inputMap[evt.sourceEvent.key] = evt.sourceEvent.type == "keydown";
            }));

            //Rendering loop (executed for everyframe)
            scene.onBeforeRenderObservable.add(() => {
                if (inputMap["p"] && !play) {
                    play = true;
                    console.log("play");
                }

                // Fim da Caçada
                if (collectedApples == totalApples) {
                    //Samba!
                    sambaAnim.start(true, 1.0, sambaAnim.from, sambaAnim.to, false);
                }
            });


        }

        function load_sounds() {
            // Background Music
            var music = new BABYLON.Sound("gameSound", "sounds/backgorundsound.mp3", scene, null, {
                volume: 0.05,
                loop: true,
                autoplay: true
            });

            // Collecting Apple
            soundCollectingApple = new BABYLON.Sound("CollectingApple", "//david.blob.core.windows.net/babylonjs/AppleCrushed.wav", scene);
        }

        function load_hero() {

            // Load hero character
            BABYLON.SceneLoader.ImportMesh("", "https://assets.babylonjs.com/meshes/", "HVGirl.glb", scene, function (newMeshes, particleSystems, skeletons, animationGroups) {
                hero = newMeshes[0];

                //Scale the model down        
                hero.scaling.scaleInPlace(0.1);

                //Lock camera on the character 
                camera.target = hero;

                //Hero character variables 
                var heroSpeed = 0.03;
                var heroSpeedBackwards = 0.01;
                var heroRotationSpeed = 0.1;

                var animating = true;

                const walkAnim = scene.getAnimationGroupByName("Walking");
                const walkBackAnim = scene.getAnimationGroupByName("WalkingBack");
                const idleAnim = scene.getAnimationGroupByName("Idle");
                sambaAnim = scene.getAnimationGroupByName("Samba");

                //Rendering loop (executed for everyframe)
                scene.onBeforeRenderObservable.add(() => {
                    var keydown = false;
                    //Manage the movements of the character (e.g. position, direction)
                    if (inputMap["w"]) {
                        hero.moveWithCollisions(hero.forward.scaleInPlace(heroSpeed));
                        keydown = true;
                    }
                    if (inputMap["s"]) {
                        hero.moveWithCollisions(hero.forward.scaleInPlace(-heroSpeedBackwards));
                        keydown = true;
                    }
                    if (inputMap["a"]) {
                        hero.rotate(BABYLON.Vector3.Up(), -heroRotationSpeed);
                        keydown = true;
                    }
                    if (inputMap["d"]) {
                        hero.rotate(BABYLON.Vector3.Up(), heroRotationSpeed);
                        keydown = true;
                    }
                    if (inputMap["b"]) {
                        keydown = true;
                    }

                    //Manage animations to be played  
                    if (keydown) {
                        if (!animating) {
                            animating = true;
                            if (inputMap["s"]) {
                                //Walk backwards
                                walkBackAnim.start(true, 1.0, walkBackAnim.from, walkBackAnim.to, false);
                            }
                            else if
                                (inputMap["b"]) {
                                //Samba!
                                sambaAnim.start(true, 1.0, sambaAnim.from, sambaAnim.to, false);
                            }
                            else {
                                //Walk
                                walkAnim.start(true, 1.0, walkAnim.from, walkAnim.to, false);
                            }
                        }
                    }
                    else {

                        if (animating) {
                            //Default animation is idle when no key is down     
                            idleAnim.start(true, 1.0, idleAnim.from, idleAnim.to, false);

                            //Stop all animations besides Idle Anim when no key is down
                            sambaAnim.stop();
                            walkAnim.stop();
                            walkBackAnim.stop();

                            //Ensure animation are played only once per rendering loop
                            animating = false;
                        }
                    }
                });
            });
        }

        function create_apples() {
            var initScale = 0.1;
            var incScale = 0.2;
            var posApplesX = [0, 4, 7, 8, 6, 3, 0, -6, -8, -4.5];
            var posApplesZ = [8, 6, 3, 0, -4, -7, -8, -5.5, 0, 4.5];

            for (var i = 0; i < totalApples; i++) {
                load_apple("apple" + i, initScale += incScale, posApplesX[i], posApplesZ[i]);
            }
        }

        function load_apple(name, scale, posX, posZ) {

            BABYLON.SceneLoader.ImportMesh("", "//david.blob.core.windows.net/babylonjs/", "Apple.glb", scene, function (newMeshes) {

                // Set Apple
                var appleItem = newMeshes[0];
                appleItem.name = name;

                // Create bodyMesh
                var bodyMesh = BABYLON.MeshBuilder.CreateSphere(name, { diameter: 1 });

                // Hide the bodyMesh
                bodyMesh.isVisible = false;

                // Set scale    
                appleItem.scaling.scaleInPlace(scale);

                // Set position
                appleItem.position.x = posX;
                appleItem.position.z = posZ;
                bodyMesh.position.x = posX;
                bodyMesh.position.z = posZ + scale / 4;
                bodyMesh.position.y = 0.5;

                var collected = false;
                scene.onBeforeRenderObservable.add(() => {
                    if (play && !collected) {
                        if (bodyMesh.intersectsMesh(hero, true)) {
                            collected = true;
                            collectedApples++;
                            textScore.text = "" + collectedApples;
                            animation_collectable(appleItem);

                            setTimeout(function () { // Set Timeout
                                appleItem.setEnabled(false);
                                soundCollectingApple.play();
                            }, 1000);
                        }
                    }
                });
            });
        }

        function start_game() {

        }

        function animation_collectable(mesh) {

            var frameRate = 10;

            //Position Animation
            var ySlide = new BABYLON.Animation("ySlide", "position.y", frameRate, BABYLON.Animation.ANIMATIONTYPE_FLOAT, BABYLON.Animation.ANIMATIONLOOPMODE_CYCLE);

            var keyFramesP = [];

            keyFramesP.push({
                frame: 0,
                value: 0
            });

            keyFramesP.push({
                frame: frameRate,
                value: 1
            });

            ySlide.setKeys(keyFramesP);

            scene.beginDirectAnimation(mesh, [ySlide], 0, 2 * frameRate, false);
        }

        // -------------------------------------------------------------------------------------- //

        window.initFunction = async function () {
            var asyncEngineCreation = async function () {
                try {
                    return createDefaultEngine();
                } catch (e) {
                    console.log("the available createEngine function failed. Creating the default engine instead");
                    return createDefaultEngine();
                }
            }

            window.engine = await asyncEngineCreation();
            if (!engine) throw 'engine should not be null.';
            window.scene = createScene();
        };
        initFunction().then(() => {
            sceneToRender = scene
            engine.runRenderLoop(function () {
                if (sceneToRender && sceneToRender.activeCamera) {
                    sceneToRender.render();
                }
            });
        });

        // Resize
        window.addEventListener("resize", function () {
            engine.resize();
        });
    </script>
</body>

</html>